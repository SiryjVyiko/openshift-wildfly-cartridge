#!/bin/bash -eu

source /opt/repo/bin/util

case "$1" in
  -v|--version)
    version="$2"
esac

echo "$version" > "/opt/repo/env/OPENSHIFT_WILDFLY_VERSION"

ln -s /opt/repo/standalone/log /opt/repo/logs

shopt -s dotglob
cp -r /opt/repo/versions/${version}/template/* /opt/repo/template
cp -r /opt/repo/versions/${version}/template/.openshift /opt/repo/template
cp /opt/repo/standalone/configuration/standalone.xml /opt/repo/template/.openshift/config/standalone.xml

sed -i "s/{APP_NAME}/${OPENSHIFT_APP_NAME}/g" $/opt/repo/template/pom.xml

# Create and install the initial template WAR
pushd /opt/repo/versions/${version}/template/src/main/webapp 1> /dev/null
  jar cvf /opt/repo/standalone/deployments/ROOT.war ./*
popd 1> /dev/null

username=$(generate_username)
password=$(generate_password)

echo "$username" > /opt/repo/env/OPENSHIFT_WILDFLY_USERNAME
echo "$password" > /opt/repo/env/OPENSHIFT_WILDFLY_PASSWORD

/opt/repo/bin/add-user.sh --user ${username} --password ${password} --silent --enable

client_result ""
client_result "WildFly 8 administrator added.  Please make note of these credentials:"
client_result ""
client_result "   Username: $username"
client_result "   Password: $password"
client_result "   "
client_result "   run 'rhc port-forward $OPENSHIFT_APP_NAME to access the web admin area on port 9990."
client_result ""


#JBOSS_HOME=/etc/alternatives/jbossas-$version
#pushd $OPENSHIFT_WILDFLY_DIR 1> /dev/null
#  ln -s ${JBOSS_HOME}/jboss-modules.jar
#  ln -s ${JBOSS_HOME}/modules
#popd 1> /dev/null

touch /opt/repo/env/OPENSHIFT_WILDFLY_CLUSTER
#touch ${OPENSHIFT_WILDFLY_DIR}/env/OPENSHIFT_JBOSSAS_CLUSTER_REMOTING

# Install Oracle JDK 8 (this should be removed once OpenShift provides support for JDK 8)
pushd /opt/repo/usr/lib/jvm > /dev/null
    if wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u5-b13/jdk-8u5-linux-i586.tar.gz > /dev/null; then
        tar -xzf jdk-8u5-linux-i586.tar.gz
        rm jdk-8u5-linux-i586.tar.gz
        update-configuration java8
    else
        # Just in case the install fails for some reason
        client_message "JDK 8 could not be installed, defaulting to JDK 7 instead"
        mv /opt/repo/template/.openshift/markers/java8 /opt/repo/template/.openshift/markers/java7
        sed -i "s/<maven.compiler.source>1.8<\/maven.compiler.source>/<maven.compiler.source>1.7<\/maven.compiler.source>/g" /opt/repo/template/pom.xml
        sed -i "s/<maven.compiler.target>1.8<\/maven.compiler.target>/<maven.compiler.target>1.7<\/maven.compiler.target>/g" /opt/repo/template/pom.xml
        sed -i '/<maven.compiler.executable>${env.OPENSHIFT_WILDFLY_DIR}usr\/lib\/jvm\/jdk1.8.0_05\/bin\/javac<\/maven.compiler.executable>/d' /opt/repo/template/pom.xml
        sed -i '/<maven.compiler.fork>true<\/maven.compiler.fork>/d' /opt/repo/template/pom.xml
        update-configuration java7
    fi
popd > /dev/null
